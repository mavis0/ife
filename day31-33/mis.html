<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">    
        <title>IFE ECMAScript</title>
    </head>
    <body>
    <!-- <select id="region-select">
    </select>
    <select id="product-select">
    </select> -->
    <div id="region-checkbox">
    </div>
    <div id="product-checkbox">
    </div>
    <div id="table-wrapper">
    </div>
    </body>
</html>
<script type="module">
    import sourceData from "./ife31data.js"
    let tableWapper= document.getElementById('table-wrapper');
    let regionCheckbox = document.getElementById('region-checkbox');
    let productCheckbox = document.getElementById('product-checkbox');
    getCheckboxOption('region', regionCheckbox);
    getCheckboxOption('product', productCheckbox);
    generateTable();

    regionCheckbox.addEventListener('click', (e) => {
        if (e.target.name == undefined) return;
        let regionAll = document.getElementsByName('region-all')[0];
        let regions = document.getElementsByName('region');
        let checkNum = Array.from(regions).filter(s => s.checked).length;
        if (e.target.name !== 'region-all') {
            console.log(checkNum);
            if (e.target.checked && checkNum == 1) e.preventDefault();
            if (!e.target.checked && checked == 2) regionAll.checked = true;
        } else {
            console.log('all selected');
            regions.forEach(x => x.checked = true);
        }
        generateTable();
    })

    productCheckbox.addEventListener('click', () => {
        generateTable();
    })
    // regionSelect.addEventListener('change', () => {
    //     generateTable();
    // })
    // productSelect.addEventListener('change', () => {
    //     generateTable();
    // })

    function getCheckboxOption (item, node) {
        let regions = sourceData.map(x => x[item]);
        for (let region of new Set(regions)) {
            let option = document.createElement('input');
            option.value = region;
            option.name = item;
            let label = document.createElement('label');
            label.innerHTML = region;
            option.type = 'checkbox';
            node.append(option);
            node.append(label);
        }
        let option = document.createElement('input');
        option.name = item + '-all';
        let label = document.createElement('label');
        label.innerHTML = '全选';
        option.type = 'checkbox';
        node.append(option);
        node.append(label);

    }
    function getSelectedData () {
        let regionSet = new Set();
        let productSet = new Set();
        let regionSelected = document.getElementsByName("region");
        let productSelected = document.getElementsByName("product");
        for (let region of regionSelected) {
            if (region.checked) regionSet.add(region.value);
        }
        for (let product of productSelected) {
            if (product.checked) productSet.add(product.value);
        }
        return sourceData.filter(s => regionSet.has(s.region) && productSet.has(s.product));
    }
    
    // let productSelect = document.getElementById('product-select');
    // let regionSelect = document.getElementById('region-select');
    // getOption();
    // generateTable();
    // regionSelect.addEventListener('change', () => {
    //     generateTable();
    // })
    // productSelect.addEventListener('change', () => {
    //     generateTable();
    // })
    // function getOption () {
    //     let regions = sourceData.map(x => x.region);
    //     let products = sourceData.map(x => x.product);
    //     for (let region of new Set(regions)) {
    //         let option = document.createElement('option');
    //         option.innerHTML = region;
    //         regionSelect.append(option);
    //     }
    //     for (let product of new Set(products)) {
    //         let option = document.createElement('option');
    //         option.innerHTML = product;
    //         productSelect.append(option);
    //     }
    // }
    // function getSelectedData () {
    //     let regionSelected = regionSelect.value;
    //     let productSelected = productSelect.value;
    //     return sourceData.filter(s => s.region === regionSelected && s.product === productSelected);
    // }
    function generateTable () {
        tableWapper.innerHTML = '';
        let data = getSelectedData();
        let table = document.createElement('table');
        table.border = '1';
        table.cellSpacing = '0';
        let headerTr = document.createElement('tr');
        table.append(headerTr);
        let headerTh = document.createElement('th');
        headerTh.innerHTML = '商品';
        headerTr.append(headerTh);
        headerTh = document.createElement('th');
        headerTh.innerHTML = '地区';
        headerTr.append(headerTh);
        for (let i = 1; i < 13 ; i++) {
            headerTh = document.createElement('th');
            headerTh.innerHTML = i + '月';
            headerTr.append(headerTh);
        }
        tableWapper.append(table);
        for (let item of data) {
            let tr = document.createElement('tr');
            let td = document.createElement('td');
            td.innerHTML = item.product;
            tr.append(td);
            td = document.createElement('td');
            td.innerHTML = item.region;
            tr.append(td);
            for (let i = 0; i < 12; i++) {
                td = document.createElement('td');
                td.innerHTML = item.sale[i];
                tr.append(td);
            }
            table.append(tr);
        }
    }
</script>